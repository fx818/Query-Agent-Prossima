<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL Agent Chat</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Custom styles for a polished look */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* A light gray background */
        }
        /* Custom spinner animation */
        .spinner {
            border: 2px solid rgba(0, 0, 0, 0.1);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border-left-color: #4f46e5; /* Indigo color for the spinner */
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Style for the response container */
        .chat-message-text {
            white-space: pre-wrap; /* Preserve formatting of the response */
            word-wrap: break-word;
        }
        /* Custom scrollbar */
        #chat-history::-webkit-scrollbar {
            width: 6px;
        }
        #chat-history::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        #chat-history::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 6px;
        }
        #chat-history::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div class="h-screen flex flex-col items-center justify-center p-4">
        <div class="w-full max-w-3xl h-full flex flex-col bg-white rounded-2xl shadow-lg border border-gray-200">

            <!-- Header -->
            <header class="text-center p-4 border-b border-gray-200">
                <h1 class="text-2xl font-bold text-gray-900">SQL Agent Chat</h1>
                <p class="text-sm text-gray-500">Logged in as: <span class="font-medium text-indigo-600">anurag</span></p>
            </header>

            <!-- Chat History -->
            <div id="chat-history" class="flex-1 p-6 space-y-4 overflow-y-auto">
                <!-- Agent Welcome Message -->
                <div class="flex items-start gap-3">
                    <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-gray-600 font-bold">A</div>
                    <div class="bg-gray-100 p-3 rounded-lg rounded-tl-none max-w-lg">
                        <p class="text-sm text-gray-800">Hello Anurag! How can I help you today? You can ask me to query the database, or use the tool buttons below.</p>
                    </div>
                </div>
                 <!-- Messages will be appended here -->
            </div>
            
             <!-- Typing Indicator -->
            <div id="typing-indicator" class="px-6 pb-2 hidden">
                 <div class="flex items-start gap-3">
                    <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-gray-600 font-bold">A</div>
                    <div class="bg-gray-100 p-3 rounded-lg rounded-tl-none flex items-center gap-2">
                         <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: -0.3s;"></div>
                         <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: -0.15s;"></div>
                         <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                    </div>
                </div>
            </div>

            <!-- Other Actions -->
            <div class="p-4 border-t border-b border-gray-200">
                <div class="flex items-center justify-center gap-2 sm:gap-4">
                    <button id="get-schema-btn" class="flex-1 sm:flex-none flex items-center gap-2 justify-center text-sm bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-700 transition duration-200">
                        Get DB Schema
                    </button>
                    <button id="get-memory-btn" class="flex-1 sm:flex-none flex items-center gap-2 justify-center text-sm bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-200">
                        Get Memory
                    </button>
                    <button id="clear-memory-btn" class="flex-1 sm:flex-none flex items-center gap-2 justify-center text-sm bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition duration-200">
                        Clear Memory
                    </button>
                </div>
            </div>

            <!-- Query Input Form -->
            <div class="p-4">
                <form id="query-form" class="flex items-center gap-4">
                    <textarea id="user_query" rows="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 resize-none" placeholder="Ask a question..."></textarea>
                    <button type="submit" class="bg-indigo-600 text-white p-3 rounded-full hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-200 flex-shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-send"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>
                    </button>
                </form>
            </div>

        </div>
    </div>

    <!-- Main script for API interaction -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Configuration ---
            // The base URL will be the current window location, so no need to hardcode it.
            const API_BASE_URL = window.location.origin;
            const USERNAME = 'anurag'; // Fixed username

            // --- DOM Element References ---
            const queryForm = document.getElementById('query-form');
            const userQueryInput = document.getElementById('user_query');
            const chatHistory = document.getElementById('chat-history');
            const typingIndicator = document.getElementById('typing-indicator');

            const getSchemaBtn = document.getElementById('get-schema-btn');
            const getMemoryBtn = document.getElementById('get-memory-btn');
            const clearMemoryBtn = document.getElementById('clear-memory-btn');

            // --- Helper Functions ---
            
            const scrollToBottom = () => {
                chatHistory.scrollTop = chatHistory.scrollHeight;
            };

            const showTypingIndicator = () => {
                typingIndicator.classList.remove('hidden');
                scrollToBottom();
            };

            const hideTypingIndicator = () => {
                typingIndicator.classList.add('hidden');
            };

            /**
             * Adds a message to the chat history.
             * @param {string} text - The message content.
             * @param {'user' | 'agent'} sender - Who sent the message.
             * @param {boolean} isError - Whether the message is an error.
             */
            const addMessageToChat = (text, sender, isError = false) => {
                const messageContainer = document.createElement('div');
                const textContent = typeof text === 'object' ? JSON.stringify(text, null, 2) : text;

                if (sender === 'user') {
                    messageContainer.className = 'flex items-start gap-3 justify-end';
                    messageContainer.innerHTML = `
                        <div class="bg-indigo-600 text-white p-3 rounded-lg rounded-br-none max-w-lg">
                            <p class="text-sm">${textContent}</p>
                        </div>
                        <div class="w-8 h-8 rounded-full bg-indigo-600 flex items-center justify-center text-white font-bold flex-shrink-0">You</div>
                    `;
                } else { // Agent
                    messageContainer.className = 'flex items-start gap-3';
                    const bgColor = isError ? 'bg-red-100' : 'bg-gray-100';
                    const textColor = isError ? 'text-red-800' : 'text-gray-800';
                    messageContainer.innerHTML = `
                        <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-gray-600 font-bold flex-shrink-0">A</div>
                        <div class="${bgColor} p-3 rounded-lg rounded-tl-none max-w-lg">
                            <pre class="text-sm ${textColor} chat-message-text">${textContent}</pre>
                        </div>
                    `;
                }

                chatHistory.appendChild(messageContainer);
                scrollToBottom();
            };
            
            // Auto-resize textarea
            userQueryInput.addEventListener('input', () => {
                userQueryInput.style.height = 'auto';
                userQueryInput.style.height = (userQueryInput.scrollHeight) + 'px';
            });
            
            userQueryInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    queryForm.dispatchEvent(new Event('submit'));
                }
            });


            // --- API Call Functions ---

            const handleQuerySubmit = async (e) => {
                e.preventDefault();
                const userQuery = userQueryInput.value.trim();
                if (!userQuery) return;

                addMessageToChat(userQuery, 'user');
                userQueryInput.value = '';
                userQueryInput.style.height = 'auto'; // Reset height
                showTypingIndicator();

                try {
                    // Your new backend doesn't use Form(...) for this endpoint,
                    // so we send the data as URL query parameters.
                    const params = new URLSearchParams({
                        username: USERNAME,
                        user_query: userQuery
                    });

                    const response = await fetch(`${API_BASE_URL}/testing_query?${params.toString()}`, {
                        method: 'POST',
                    });

                    const result = await response.json();
                    
                    if (!response.ok || result.error) {
                        throw new Error(result.error || `HTTP error! status: ${response.status}`);
                    }
                    
                    addMessageToChat(result.response || 'No response content.', 'agent');

                } catch (error) {
                    console.error('Error submitting query:', error);
                    addMessageToChat(`Failed to get response: ${error.message}`, 'agent', true);
                } finally {
                    hideTypingIndicator();
                }
            };
            
            const getDbSchema = async () => {
                addMessageToChat('Requesting DB Schema...', 'user');
                showTypingIndicator();
                try {
                    const response = await fetch(`${API_BASE_URL}/get_db_schema`, { method: 'POST' });
                    const result = await response.json();

                    if (!response.ok) {
                        throw new Error(result.error || `HTTP error! status: ${response.status}`);
                    }
                    addMessageToChat(result.schema || 'No schema returned.', 'agent');
                } catch (error) {
                    console.error('Error getting schema:', error);
                    addMessageToChat(`Failed to get schema: ${error.message}`, 'agent', true);
                } finally {
                    hideTypingIndicator();
                }
            };
            
            const getMemory = async () => {
                addMessageToChat('Requesting memory...', 'user');
                showTypingIndicator();
                try {
                     // Your new backend doesn't use Form(...) for this endpoint,
                    // so we send the data as a URL query parameter.
                    const params = new URLSearchParams({ username: USERNAME });
                    const response = await fetch(`${API_BASE_URL}/get_memory?${params.toString()}`, {
                        method: 'POST',
                    });
                    
                    const result = await response.json();
                    if (!response.ok || result.error) {
                         throw new Error(result.error || `No memory found for user.`);
                    }
                    addMessageToChat(result.memory, 'agent');

                } catch (error) {
                    console.error('Error getting memory:', error);
                    addMessageToChat(`Failed to get memory: ${error.message}`, 'agent', true);
                } finally {
                    hideTypingIndicator();
                }
            };

            const clearMemory = async () => {
                addMessageToChat('Requesting to clear memory...', 'user');
                showTypingIndicator();
                try {
                    const response = await fetch(`${API_BASE_URL}/clear_memory?username=${encodeURIComponent(USERNAME)}`, {
                        method: 'DELETE',
                    });
                    
                    const result = await response.json();
                    if (!response.ok) {
                        throw new Error(result.error || 'Failed to clear memory.');
                    }
                    addMessageToChat(result.status || 'Memory cleared successfully.', 'agent');

                } catch (error) {
                    console.error('Error clearing memory:', error);
                    addMessageToChat(`Failed to clear memory: ${error.message}`, 'agent', true);
                } finally {
                    hideTypingIndicator();
                }
            };

            // --- Event Listeners ---
            queryForm.addEventListener('submit', handleQuerySubmit);
            getSchemaBtn.addEventListener('click', getDbSchema);
            getMemoryBtn.addEventListener('click', getMemory);
            clearMemoryBtn.addEventListener('click', clearMemory);
        });
    </script>
</body>
</html>

